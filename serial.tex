%------------------------------------------------------------------------------
% Template file for the submission of papers to IUCr journals in LaTeX2e
% using the iucr document class
% Copyright 1999-2013 International Union of Crystallography
% Version 1.6 (28 March 2013)
%------------------------------------------------------------------------------

\documentclass[preprint]{iucr}              % DO NOT DELETE THIS LINE

     %-------------------------------------------------------------------------
     % Information about journal to which submitted
     %-------------------------------------------------------------------------
     \journalcode{J}              % Indicate the journal to which submitted
                                  %   A - Acta Crystallographica Section A
                                  %   B - Acta Crystallographica Section B
                                  %   C - Acta Crystallographica Section C
                                  %   D - Acta Crystallographica Section D
                                  %   E - Acta Crystallographica Section E
                                  %   F - Acta Crystallographica Section F
                                  %   J - Journal of Applied Crystallography
                                  %   M - IUCrJ
                                  %   S - Journal of Synchrotron Radiation

\begin{document}                  % DO NOT DELETE THIS LINE

     %-------------------------------------------------------------------------
     % The introductory (header) part of the paper
     %-------------------------------------------------------------------------

     % The title of the paper. Use \shorttitle to indicate an abbreviated title
     % for use in running heads (you will need to uncomment it).

\title{Application of signal separation to diffraction image compression and serial crystallograpby}
%\shorttitle{Short Title}

     % Authors' names and addresses. Use \cauthor for the main (contact) author.
     % Use \author for all other authors. Use \aff for authors' affiliations.
     % Use lower-case letters in square brackets to link authors to their
     % affiliations; if there is only one affiliation address, remove the [a].

\cauthor[a]{Jérôme}{Kieffer}{jerome.kieffer@esrf.fr}
\author[b]{Forename}{Surname}
Nicolas Coquelle
Jonathan P. Wright
Gavin Vaughan
Jianluca santoni
daniele de sanctis

\aff[a]{European Synchrotron Radiation Facility;71, avenue des Martyrs;CS 40220;38043 Grenoble Cedex 9 \country{France}}
\aff[b]{Second affiliation address}

     % Use \shortauthor to indicate an abbreviated author list for use in
     % running heads (you will need to uncomment it).

%\shortauthor{Soape, Author and Doe}

     % Use \vita if required to give biographical details (for authors of
     % invited review papers only). Uncomment it.

%\vita{Author's biography}

     % Keywords (required for Journal of Synchrotron Radiation only)
     % Use the \keyword macro for each word or phrase, e.g. 
     % \keyword{X-ray diffraction}\keyword{muscle}

%\keyword{keyword}

     % PDB and NDB reference codes for structures referenced in the article and
     % deposited with the Protein Data Bank and Nucleic Acids Database (Acta
     % Crystallographica Section D). Repeat for each separate structure e.g
     % \PDBref[dethiobiotin synthetase]{1byi} \NDBref[d(G$_4$CGC$_4$)]{ad0002}

%\PDBref[optional name]{refcode}
%\NDBref[optional name]{refcode}

\maketitle                        % DO NOT DELETE THIS LINE

\begin{synopsis}
Precise background assessement and application to single crystal image compression and serial crystallography data preprocessing. 
\end{synopsis}

\begin{abstract}
Abstract goes here.
\end{abstract}


     %-------------------------------------------------------------------------
     % The main body of the paper
     %-------------------------------------------------------------------------
     % Now enter the text of the document in multiple \section's, \subsection's
     % and \subsubsection's as required.

\section{Introduction}

%\cite{Cheetah2014}

\section{Algorithm for the separation of amorphous background from Bragg peaks}
\subsection{Background scattering}
The core idea of the separation of Bragg peaks from background is to consider that the background scattering 
is originating from unordered matter which gives some isotropic signal, preferably with smooth variations.
For this the raw signal has to be corrected from dark noise and any systematic anisotropic effects like polarization corrections.

The initial implementation in pyFAI \cite{pdj2013} relied on a 2D radial transform followed by a median filter in the azimuthal dimension 
to separate amorphous scattering from crystalline scattering.
Despite this method has been successfully used for large dataset analysis \cite{brocades}, it has several major drawbacks:
* The 2D averaging mixes the signal of several pixels and blures the signal. 
* Pixel-splitting is needed to leverage the moiré effect in the 2D averaging, but this increases further the blurring. 
* The filtered 1D curve obtained after the median shows sharp jumps from one azimuthal bin to its neighbor.
* Median filter is complicated and requires a lot of memory.
    
The coming sections present an efficient way to perform the azimuthal averaging and the associated variance propagation, 
and how it can be used to perform the statistical analysis to extract the background from a diffraction image. 

\subsection{Efficient azimuthal averaging and uncertainties evaluation}

\subsubsection{Preprocessing} is a pixel-wise correction for flat and normalization \cite{pyfai_2020}: 
\begin{equation}
I_{cor} = \frac{signal}{normalization}  = \frac{I_{raw} - I_{dark}}{F \cdot
\Omega \cdot P \cdot A \cdot I_0} 
\end{equation}

where $I_{raw}$ is the detector's raw signal, $I_{dark}$ is the dark current
image (it may also be the background image for certain experiments), $F$ is a 
factor accounting for the flat-field correction, $\Omega$ is the solid
angle subtended by a given pixel, $P$ is the polarisation correction term and
$A$ represents the detector's apparent efficiency due to the incidence angle of the
photon on the detector (for integrating detectors, high energy photons with
larger incidence angle see larger sensor thickness, and thus have higher
detection probability).
$I_{raw}$ may be normalized by the incoming flux $I_0$, which is
independent of the pixel position.

\subsubsection{Azimuthal averaging} was initially implemented using histograms but this was pretty slow.
Since the the geometry of the experimental setup is fixed during the acquisition, 
a look-up table listing all pixels contributing to every azimuthal bin can be built and used to speed-up calculations.
\begin{equation}
<I>_{r} = \frac{\sum\limits_{i \in bin_r} c_i \cdot signal_i}
                        {\sum\limits_{i \in bin_r} c_i \cdot normalization_i} 
\end{equation}

The azimuthal transformation can then be seen as a linear tranformation and implemented as a ``sparse-matrix times dense vector'' multiplication 
where the dense vector is simply the flattened view of the diffraction image\cite{pyFAI_gpu}. 
The CSR-sparse matrix representation is often used since it is very efficient to perform dot products with dense vectors.
In the case where pixel splitting is deactivated (i.e. each pixel contribute to a single bin) the numerical values in the sparse value ($c_i$) are always `one` (and zero elsewhere).
The sparse matrix multiplication can be used to sum efficiently values for all pixels belonging to the same bin.
To obtain the average value for a given bin, the summed signal must be divided by the summed normalization 
  
\subsubsection{Uncertainty evaluation from Poisson law.}
Photon counting suffered from several uncertainies, among which the most important one is usually the counting statistics (often refered as Poisson law)
stating that the variance for a pixel is at least the number of events counted.
Other sources of noise superimposes quadratically to the Poisson noise, like the dark-current noise:     

\begin{equation}
var(I) = (\sigma(I))^{2} = I_{raw} + (\sigma_{dark})^{2}  
\end{equation}

During the regrouping part, the coeficients of the sparse matrix needs to be squarred as described: 
\begin{equation}
\sigma_{r}(I) = \frac{\sqrt{\sum\limits_{i \in bin_r} c_i^2 \cdot variance_i}}
                  {\sum\limits_{i \in bin_r} c_i \cdot normalization_i} 
\end{equation}

\subsubsection{Uncertainty evaluation from variance in a bin.}
All pixels falling into a single bin should have the same numerical value and the deviation to this value can be seen as an estimation for the uncertainty.
Variance and standard deviation are best obtained from a double pass algorithm, one pass to calculate the average value and a second to calculate the variance, 
due to numerical stability issues. 
But several single pass implementation exist \cite{variance2018} and offer the ability to perform a parallel reduction for average and variance. 
If $P$ is a partition of the ensemble, let $\Omega_{P}$, $V_{P}$ and $VV_{P}$  be the weight sum, the weighted sum of $V$ and the weighted sum of deviation squared over the partition $P$ 
where the weight for a pixel is $\omega_i = c_i \cdot normalization_i$ and the 
\begin{equation}
\Omega_{P} = \sum\limits_{i \in P} c_i
\end{equation}
\begin{equation}
\V_{P} = \sum\limits_{i \in P} \omega_i \cdot v_i =  \sum\limits_{i \in P} signal_i
\end{equation}
\begin{equation}
VV_{p} = \sum\limits_{i \in P} \omega_i \cdot (v_i - V_{P}/\Omega_{P})^2
\end{equation}

The average and the variance can be expressed as:
\begin{equation}
avg_{p} =  <v_P> = V_{P}/\Omega_{P} 
\end{equation}

\begin{equation}
var_{p} =  (\sigma_P)^2 = VV_{P}/\Omega_{P} 
\end{equation}


When performing the union of two partition $A$ and $B$, to allow the parallel execution of the reduction, one obtains:
\begin{equation}
\Omega_{A \cup B} =  \Omega_{A} + \Omega_{B} 
\end{equation}

\begin{equation}
\V_{A \cup B} =  V_{A} + V_{B} 
\end{equation}
  
\begin{equation}
\VV_{A \cup B} =  VV_{A} + VV_{B} +  \frac{(\Omega_{A} \cdot V_{B} - \Omega_{B}\cdot V_{A})^2}{\V_{A \cup B} \cdot  V_{A} \cdot V_{B}}
\end{equation}
  
The issue of numerical unstability has been addressed by using double-precision arithmetics when implemented on CPU and double-word arithmetics when running on GPU \cite{double_word}.

\subsection{Histogram intensity }

The figure \ref{} presents the diffraction from a single crystal of protein  as advertized by the  

\subsection{Sigma-clipping}
\cite{Sivia2006}
\subsubsection{Chauvenet}




\section{Application to single crystal diffraction image compression}

\section{Application to serial crystallography}

\subsection{Performance}
     % comparison with cheetah
\section{Conclusion}

\appendix
\section{Appendix title}

Text text text text text text text text text text text text text text
text text text text text text text.

\subsection{Title}

Text text text text text text text text text text text text text text
text text text text text text text.

\subsubsection{Title}

Text text text text text text text text text text text text text text
text text text text text text text.


     %-------------------------------------------------------------------------
     % The back matter of the paper - acknowledgements and references
     %-------------------------------------------------------------------------

     % Acknowledgements come after the appendices

\ack{Acknowledgements}



\bibliographystyle{iucr}
\bibliography{biblio}

\end{document}                    % DO NOT DELETE THIS LINE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
